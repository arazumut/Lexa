{{ define "content" }}
<div class="block-header">
    <div class="row">
        <div class="col-lg-6 col-md-6 col-sm-12">
            <h2>Dashboard</h2>
            <ul class="breadcrumb">
                <li class="breadcrumb-item"><a href="/"><i class="fa fa-dashboard"></i></a></li>
                <li class="breadcrumb-item">Dashboard</li>
                <li class="breadcrumb-item active">Genel Bakış</li>
            </ul>
        </div>
        <div class="col-lg-6 col-md-6 col-sm-12">
            <div class="d-flex flex-row-reverse">
                <div class="page_action">
                    <a href="/cases/new" class="btn btn-primary"><i class="fa fa-plus"></i> Yeni Dosya</a>
                    <a href="/clients/new" class="btn btn-secondary"><i class="fa fa-user-plus"></i> Yeni Müvekkil</a>
                    <a href="/hearings/new" class="btn btn-warning"><i class="fa fa-calendar"></i> Duruşma</a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row clearfix row-deck">
    <div class="col-lg-3 col-md-6 col-sm-6">
        <div class="card number-chart">
            <div class="body">
                <span class="text-uppercase">Dosyalar</span>
                <h4 class="mb-0 mt-2">{{ .activeCases }} <i class="fa fa-folder-open font-12"></i></h4>
                <small class="text-muted">Aktif Dava Dosyaları</small>
            </div>
            <div class="sparkline" data-type="line" data-spot-Radius="0" data-offset="90" data-width="100%"
                data-height="50px" data-line-Width="1" data-line-Color="#39afa6" data-fill-Color="#73cec7">
                <!-- Grafik şimdilik dekoratif kalsın veya kaldırılabilir -->
                4,1,5,2,7,3,4
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 col-sm-6">
        <div class="card number-chart">
            <div class="body">
                <span class="text-uppercase">Müvekkiller</span>
                <h4 class="mb-0 mt-2">{{ .totalClients }}</h4>
                <small class="text-muted">Toplam Müvekkil</small>
            </div>
            <div class="sparkline" data-type="line" data-spot-Radius="0" data-offset="90" data-width="100%"
                data-height="50px" data-line-Width="1" data-line-Color="#ffa901" data-fill-Color="#efc26b">
                1,4,2,3,6,2
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 col-sm-6">
        <div class="card number-chart">
            <div class="body">
                <span class="text-uppercase">Bakiye</span>
                <h4 class="mb-0 mt-2">{{ .totalRevenue }}</h4>
                <small class="text-muted">Toplam Tahsilat</small>
            </div>
            <div class="sparkline" data-type="line" data-spot-Radius="0" data-offset="90" data-width="100%"
                data-height="50px" data-line-Width="1" data-line-Color="#38c172" data-fill-Color="#84d4a6">
                1,4,2,3,1,5
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 col-sm-6">
        <div class="card number-chart">
            <div class="body">
                <span class="text-uppercase">Yaklaşan Duruşmalar</span>
                <h4 class="mb-0 mt-2">{{ len .upcomingHearings }}</h4>
                <small class="text-muted">Önümüzdeki 7 Gün</small>
            </div>
            <!-- Sparkline yerine mini liste -->
            <div class="mt-2" style="max-height: 60px; overflow-y: hidden;">
                {{ range .upcomingHearings }}
                <small class="d-block text-truncate"><i class="fa fa-calendar"></i> {{ .Date.Format "02.01 15:04" }} -
                    {{ .Title }}</small>
                {{ else }}
                <small class="text-muted">Planlanmış duruşma yok.</small>
                {{ end }}
            </div>
        </div>
    </div>
</div>

<div class="row clearfix row-deck">
    <div class="col-lg-12">
        <div class="card">
            <div class="header">
                <h2>Gelir/Gider Özeti</h2>
            </div>
            <div class="body">
                <div id="financial-chart" style="height: 300px"></div>
                <script>
                    document.addEventListener("DOMContentLoaded", function () {
                        // Backend'den gelen veriyi güvenli bir şekilde al
                        var stats = JSON.parse('{{ .monthlyStats }}');

                        if (!stats || stats.length === 0) {
                            document.getElementById('financial-chart').innerHTML = '<div class="text-center text-muted p-4">Henüz finansal veri yok.</div>';
                            return;
                        }

                        var months = ['x'];
                        var income = ['Gelir'];
                        var expense = ['Gider'];

                        stats.forEach(function (s) {
                            months.push(s.Month);
                            income.push(s.Income);
                            expense.push(s.Expense);
                        });

                        var chart = c3.generate({
                            bindto: '#financial-chart',
                            data: {
                                x: 'x',
                                columns: [
                                    months,
                                    income,
                                    expense
                                ],
                                type: 'bar', // Bar grafiği daha şık durur
                                colors: {
                                    'Gelir': '#28a745', // Yeşil
                                    'Gider': '#dc3545'  // Kırmızı
                                }
                            },
                            axis: {
                                x: {
                                    type: 'category', // Ay isimleri kategori olarak
                                    tick: {
                                        rotate: -45,
                                        multiline: false
                                    },
                                    height: 50
                                },
                                y: {
                                    tick: {
                                        format: d3.format(",") // Binlik ayracı
                                    }
                                }
                            },
                            grid: {
                                y: {
                                    show: true
                                }
                            }
                        });
                    });
                </script>
            </div>
        </div>
    </div>
</div>

<!-- Son Dava Dosyaları Tablosu -->
<div class="row clearfix">
    <div class="col-lg-12">
        <div class="card">
            <div class="header">
                <h2>Son Eklenen Dosyalar</h2>
                <ul class="header-dropdown">
                    <li><a href="/cases" class="btn btn-sm btn-outline-primary">Tümünü Gör</a></li>
                </ul>
            </div>
            <div class="body">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Dosya No</th>
                                <th>Dava Konusu</th>
                                <th>Müvekkil</th>
                                <th>Durum</th>
                                <th>Tarih</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{ range .recentCases }}
                            <tr>
                                <td><a href="/cases/{{ .ID }}/edit"><strong>{{ .FileNumber }}</strong></a></td>
                                <td>{{ .Title }}</td>
                                <td>{{ if .Client }}{{ .Client.Name }}{{ else }}-{{ end }}</td>
                                <td>
                                    {{ if eq .Status "active" }}<span class="badge badge-success">Aktif</span>
                                    {{ else if eq .Status "closed" }}<span class="badge badge-success">Kapandı</span>
                                    {{ else }}<span class="badge badge-default">{{ .Status }}</span>{{ end }}
                                </td>
                                <td>{{ .CreatedAt.Format "02.01.2006" }}</td>
                            </tr>
                            {{ else }}
                            <tr>
                                <td colspan="5" class="text-center text-muted">Henüz dosya kaydı yok.</td>
                            </tr>
                            {{ end }}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{{ end }}

{{ define "scripts" }}
<!-- D3 ve C3 kütüphaneleri asıl layout'ta varsa buraya eklemeye gerek yok ama
     base.html'de c3.bundle.js var, o yüzden yeterli. -->
<script src="/assets/bundles/c3.bundle.js"></script>

{{ end }}