{{ define "content" }}
<div class="block-header">
    <div class="row">
        <div class="col-lg-6 col-md-8 col-sm-12">
            <h2><a href="javascript:void(0);" class="btn btn-xs btn-link btn-toggle-fullwidth"><i
                        class="fa fa-arrow-left"></i></a> Duruşmalar</h2>
            <ul class="breadcrumb">
                <li class="breadcrumb-item"><a href="/"><i class="icon-home"></i></a></li>
                <li class="breadcrumb-item">Duruşma Takibi</li>
            </ul>
        </div>
        <div class="col-lg-6 col-md-4 col-sm-12 text-right">
            <div class="d-flex flex-row-reverse align-items-center">
                <a href="/hearings/new" class="btn btn-primary ml-2"><i class="fa fa-plus"></i> Yeni Duruşma Planla</a>

                <div class="btn-group btn-group-toggle" data-toggle="buttons">
                    <label class="btn btn-outline-secondary active" onclick="showView('list')">
                        <input type="radio" name="view" autocomplete="off" checked> Liste
                    </label>
                    <label class="btn btn-outline-secondary" onclick="showView('calendar')">
                        <input type="radio" name="view" autocomplete="off"> Takvim
                    </label>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row clearfix">
    <div class="col-lg-12">
        <div class="card">

            <!-- LISTE GÖRÜNÜMÜ -->
            <div id="listView">
                <div class="header">
                    <h2>Yaklaşan ve Geçmiş Duruşmalar</h2>
                </div>
                <div class="body">
                    <div class="table-responsive">
                        <table
                            class="table table-hover js-basic-example dataTable table-custom dt-responsive nowrap w-100"
                            id="hearingsTable">
                            <thead class="thead-dark">
                                <tr>
                                    <th data-priority="1">Tarih / Saat</th>
                                    <th data-priority="3">Durum</th>
                                    <th>Dava Dosyası</th>
                                    <th data-priority="2">Konu</th>
                                    <th>Konum / Mahkeme</th>
                                    <th data-priority="4">İşlemler</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- TAKVİM GÖRÜNÜMÜ -->
            <div id="calendarView" style="display: none;">
                <div class="body">
                    <div id="calendar"></div>
                </div>
            </div>

        </div>
    </div>
</div>
{{ end }}

{{ define "scripts" }}
<link rel="stylesheet" href="/assets/vendor/jquery-datatable/dataTables.bootstrap4.min.css">
<!-- FullCalendar CSS -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />

<script src="/assets/bundles/datatablescripts.bundle.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<!-- FullCalendar JS -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/tr.js'></script>

<script>
    var calendar = null;

    $(document).ready(function () {
        // 1. DataTables Init
        var table = $('#hearingsTable').DataTable({
            "processing": true,
            "serverSide": true,
            "ajax": "/api/hearings",
            "order": [[0, "asc"]],
            "columns": [
                {
                    "data": "date", "render": function (data) {
                        return moment(data).format('DD.MM.YYYY HH:mm');
                    }
                },
                {
                    "data": "status", "render": function (data) {
                        var map = {
                            'scheduled': '<span class="badge badge-primary">Planlandı</span>',
                            'completed': '<span class="badge badge-success">Tamamlandı</span>',
                            'postponed': '<span class="badge badge-warning">Ertelendi</span>',
                            'cancelled': '<span class="badge badge-danger">İptal</span>'
                        };
                        return map[data] || data;
                    }
                },
                {
                    "data": "case", "render": function (data) {
                        if (!data) return '-';
                        return '<a href="/cases/' + data.id + '/edit"><strong>' + data.file_number + '</strong></a><br><small>' + data.client.name + '</small>';
                    }
                },
                { "data": "title" },
                { "data": "location" },
                {
                    "data": "id", "orderable": false, "render": function (data) {
                        return '<a href="/hearings/' + data + '/edit" class="btn btn-sm btn-outline-secondary" title="Düzenle"><i class="fa fa-edit"></i></a>' +
                            ' <button class="btn btn-sm btn-outline-danger" onclick="deleteHearing(' + data + ')" title="Sil"><i class="fa fa-trash-o"></i></button>';
                    }
                }
            ],
            "responsive": true,
            "language": { "url": "//cdn.datatables.net/plug-ins/1.10.20/i18n/Turkish.json" }
        });
    });

    // Görünüm Değiştirme
    function showView(viewName) {
        if (viewName === 'list') {
            document.getElementById('listView').style.display = 'block';
            document.getElementById('calendarView').style.display = 'none';
        } else {
            document.getElementById('listView').style.display = 'none';
            document.getElementById('calendarView').style.display = 'block';

            // Calendar ilk kez açılıyorsa render et
            if (!calendar) {
                initCalendar();
            } else {
                calendar.updateSize(); // Görünür olunca boyutunu güncelle
            }
        }
    }

    // FullCalendar Init
    function initCalendar() {
        var calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'tr',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            events: '/api/hearings/calendar', // JSON Endpoint
            eventClick: function (info) {
                if (info.event.url) {
                    window.location.href = info.event.url;
                    info.jsEvent.preventDefault();
                }
            },
            height: 650
        });
        calendar.render();
    }

    function deleteHearing(id) {
        if (confirm("Bu duruşma kaydını silmek istediğinize emin misiniz?")) {
            $.ajax({
                url: '/api/hearings/' + id,
                type: 'DELETE',
                success: function (result) {
                    toastr.success("Duruşma silindi.", "Başarılı");
                    $('#hearingsTable').DataTable().ajax.reload();
                    if (calendar) calendar.refetchEvents(); // Takvimi de yenile
                },
                error: function (xhr) {
                    toastr.error("Hata: " + (xhr.responseJSON ? xhr.responseJSON.error : "Bilinmeyen hata"), "Hata");
                }
            });
        }
    }
</script>
{{ end }}